name: first github actions
on:
  push:
    branches:
      - main
    pull_request:
      - main
    workflow_dispatch:
jobs:
  maven:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: hello world
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: java version
        run: java -version
      - name: maven installation
        run: | 
             sudo apt install maven -y
             sudo mkdir maven
             cd maven
             sudo git clone https://github.com/krishnapuppala97/maven-web-application.git 
             pwd |ls -l
             cd maven-web-application
             sudo mvn clean package install
             docker build . --file Dockerfile --tag laxm:1 
             
 #    - name: Login to Docker Hub
 #      uses: docker/login-action@v2
              
#       with: 
 #      username: ${{ secrets.DOCKERHUB_USERNAME }}
#       password: ${{ secrets.DOCKERHUB_TOKEN }}
  #   - name: pushing immage to docker hub
 #      uses: docker/build-push-action@v2
  #     with:
  #       context: .
 #        file: Dockerfile
     #    push: true
     #    tags: ${{ secrets.DOCKERHUB_USERNAME }}/laxmi:1234
          
        
      #    shell: bash 

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: repositoryforgithub
          IMAGE_TAG: laxmi:1
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

